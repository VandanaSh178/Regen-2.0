<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTRA | Perimeter Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #020617;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-heavy: rgba(255, 255, 255, 0.07);
            --border: rgba(255, 255, 255, 0.08);
            --blue: #3b82f6;
            --cyan: #06b6d4;
            --green: #10b981;
            --red: #ef4444;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #06b6d4;
        }

        * { box-sizing: border-box; transition: all 0.2s ease-in-out; }
        
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at 0% 0%, #0f172a 0%, #020617 100%);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 280px;
            background: rgba(2, 6, 23, 0.6);
            backdrop-filter: blur(30px);
            border-right: 1px solid var(--border);
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-header { text-align: center; margin-bottom: 40px; }
        .brand-title {
            font-family: 'Montserrat';
            font-size: 24px;
            letter-spacing: 4px;
            font-weight: 800;
            background: linear-gradient(to bottom, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .menu a:hover { background: var(--glass); color: white; }
        .menu a.active {
            background: rgba(6, 182, 212, 0.1);
            color: var(--cyan);
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ===== MAIN CONTENT ===== */
        .main { flex: 1; padding: 40px; overflow-y: auto; scroll-behavior: smooth; }
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .panel {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 24px;
            backdrop-filter: blur(10px);
            padding: 24px;
            margin-bottom: 24px;
        }

        /* ===== VIDEO HUD ===== */
        .video-container {
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            background: #000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .hud-overlay {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px 25px;
            border-radius: 15px;
            border-left: 4px solid var(--cyan);
            backdrop-filter: blur(10px);
            min-width: 200px;
            z-index: 30;
        }

        .lock-curtain {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(239, 68, 68, 0.2);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
            flex-direction: column;
        }

        .lockdown-active { border: 2px solid var(--red) !important; animation: pulseRed 1.5s infinite; }
        @keyframes pulseRed { 0% { box-shadow: inset 0 0 20px var(--red); } 50% { box-shadow: inset 0 0 60px var(--red); } 100% { box-shadow: inset 0 0 20px var(--red); } }

        /* ===== TABLES & PILLS ===== */
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { text-align: left; color: var(--text-muted); font-size: 11px; text-transform: uppercase; padding: 15px; }
        td { padding: 15px; background: var(--glass); font-size: 14px; }
        td:first-child { border-radius: 12px 0 0 12px; }
        td:last-child { border-radius: 0 12px 12px 0; }

        .pill { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .pill-auth { background: rgba(16, 185, 129, 0.1); color: var(--green); border: 1px solid var(--green); }
        .pill-block { background: rgba(239, 68, 68, 0.1); color: var(--red); border: 1px solid var(--red); }

        /* ===== METRICS ===== */
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .metric-card { background: var(--glass); border: 1px solid var(--border); padding: 20px; border-radius: 20px; }
        .metric-card h3 { font-size: 28px; margin: 0; font-family: 'Montserrat'; }
        .metric-card p { margin: 5px 0 0; color: var(--text-muted); font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

        /* ===== ABOUT PAGE SPECIFIC ===== */
        .glow-text { font-family: 'Montserrat'; font-weight: 800; font-size: 42px; margin-bottom: 10px; }
        .about-hero-glass { padding: 60px 40px; background: radial-gradient(circle at top right, rgba(6, 182, 212, 0.15), transparent); border-radius: 24px; border: 1px solid var(--border); margin-bottom: 30px; }
        .about-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .info-card { background: var(--glass); border: 1px solid var(--border); padding: 25px; border-radius: 20px; }
        .badge { display: inline-block; background: rgba(6, 182, 212, 0.1); color: var(--cyan); padding: 4px 12px; border-radius: 4px; font-size: 10px; font-weight: 800; border: 1px solid rgba(6, 182, 212, 0.3); margin-bottom: 15px; }
        
        .spec-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px; }
        @media (min-width: 900px) { .spec-grid { grid-template-columns: repeat(4, 1fr); } }
        .spec-item span { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }
        .spec-item strong { display: block; font-size: 14px; margin-top: 4px; color: var(--cyan); }

        .flow-steps { display: flex; align-items: center; justify-content: space-between; margin-top: 40px; text-align: center; font-size: 12px; }
        .step-dot { width: 12px; height: 12px; background: var(--cyan); border-radius: 50%; margin: 0 auto 10px; box-shadow: 0 0 15px var(--cyan); }
        .arrow-line { height: 1px; flex: 1; background: var(--border); margin: 0 15px; position: relative; top: -18px; }

    </style>
</head>

<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <div class="brand-title">ASTRA</div>
            <p style="font-size: 9px; color: var(--cyan); letter-spacing: 2px; margin-top: 5px; font-weight: 700;">PERIMETER INTELLIGENCE</p>
        </div>

        <div class="menu">
            <a id="nav-home" class="active" onclick="showSection('home', this)">üõ°Ô∏è Dashboard</a>
            <a id="nav-history" onclick="showSection('history', this)">üìë Entry Logs</a>
            <a id="nav-about" onclick="showSection('about', this)">‚ú® Technical Specs</a>
            <a href="/">üîÑ Re-run Intro</a>
        </div>

        <div style="margin-top: auto; padding: 15px; background: rgba(59, 130, 246, 0.05); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.1);">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 8px; height: 8px; background: var(--green); border-radius: 50%; box-shadow: 0 0 10px var(--green);"></div>
                <span style="font-size: 11px; font-weight: 600; letter-spacing: 1px;">AI CORE ONLINE</span>
            </div>
        </div>

        <div class="sidebar-footer">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>V2.4.0-STABLE</span>
                <span id="live-clock">00:00:00</span>
            </div>
            <div style="opacity: 0.5; line-height: 1.4;">
                ¬© 2026 NIT Manipur<br>Security R&D Division
            </div>
        </div>
    </div>

    <div class="main">

        <div id="home" class="section active">
            <div style="margin-bottom: 30px;">
                <h1 style="margin: 0; font-family: 'Montserrat'; font-size: 28px;">Command Center</h1>
                <p style="color: var(--text-muted); margin-top: 5px;">Live Neural Stream ‚Äî Gate Alpha-01</p>
            </div>

            <div style="display: grid; grid-template-columns: 2.5fr 1fr; gap: 25px;">
                <div class="video-container" id="mainVideoContainer">
                    <div id="lockCurtain" class="lock-curtain">
                        <div style="font-size: 50px; margin-bottom: 10px;">üîí</div>
                        <h2 style="color: white; font-family: Montserrat; font-weight: 800; margin: 0;">ACCESS DENIED</h2>
                        <p style="color: white; font-size: 10px; letter-spacing: 2px; opacity: 0.8;">SECURITY LOCKDOWN ACTIVE</p>
                    </div>
                    
                    <img src="/video_feed" width="100%" style="display: block; min-height: 480px; background: #000; object-fit: cover;">
                    
                    <div class="hud-overlay">
                        <div style="font-size: 9px; color: var(--cyan); font-weight: 700; margin-bottom: 5px; letter-spacing: 1px;">CURRENT DETECTION</div>
                        <div id="hud-plate" style="font-size: 26px; font-weight: 800; font-family: 'Montserrat'; margin-bottom: 12px;">SCANNING...</div>
                        <button id="overrideBtn" onclick="manualUnlock()" style="display: none; width: 100%; padding: 12px; background: rgba(16, 185, 129, 0.15); border: 1px solid var(--green); border-radius: 8px; color: var(--green); font-size: 10px; font-weight: 800; cursor: pointer;">üîì MANUAL OVERRIDE</button>
                    </div>
                </div>

                <div class="panel" style="display: flex; flex-direction: column; margin-bottom: 0;">
                    <h4 style="margin: 0 0 15px; font-size: 12px; color: var(--text-muted); letter-spacing: 1px;">REAL-TIME FEED</h4>
                    <div id="miniHistory" style="flex: 1; overflow-y: auto;">
                        <p style="color: var(--text-muted); font-size: 12px; text-align: center; margin-top: 50px;">Waiting for vehicle detection...</p>
                    </div>
                </div>
            </div>

            <div class="metrics">
                <div class="metric-card"><h3 id="m1">0</h3><p>Total Detections</p></div>
                <div class="metric-card"><h3 id="m2" style="color: var(--green);">0</h3><p>Authorized</p></div>
                <div class="metric-card"><h3 id="m3" style="color: var(--red);">0</h3><p>Blacklisted</p></div>
                <div class="metric-card"><h3 style="color: var(--cyan);">99.4%</h3><p>Model Precision</p></div>
            </div>
        </div>

        <div id="history" class="section">
            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-family: Montserrat; margin: 0;">System Entry Logs</h2>
                    <button onclick="loadPersistentLogs()" style="background: var(--glass-heavy); border: 1px solid var(--border); color: white; padding: 8px 15px; border-radius: 8px; font-size: 12px; cursor: pointer;">üîÑ Refresh</button>
                </div>
                <table>
                    <thead>
                        <tr><th>Timestamp</th><th>Plate Number</th><th>Category</th><th>Action</th></tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr><td colspan="4" style="text-align: center; opacity: 0.5;">No logs available</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="about" class="section">
            <div class="about-hero-glass">
                <div class="badge">NIT MANIPUR R&D PROJECT</div>
                <h1 class="glow-text">The <span style="color: var(--cyan)">ASTRA</span> Engine</h1>
                <p style="font-size: 18px; line-height: 1.6; color: var(--text-muted); max-width: 800px;">
                    Astra is a high-speed neural pipeline designed for autonomous campus surveillance. 
                    It eliminates manual registers, reducing <b style="color:var(--cyan)">human error</b> and wait times at entry points.
                </p>
            </div>

            <div class="about-grid">
                <div class="info-card">
                    <h3 style="font-family: Montserrat; color: var(--cyan);">Neural Speed</h3>
                    <p style="font-size: 14px; color: var(--text-muted);">Inference optimized for sub-800ms response times. Zero bottleneck at gates.</p>
                </div>
                <div class="info-card">
                    <h3 style="font-family: Montserrat; color: var(--cyan);">Zero Trust</h3>
                    <p style="font-size: 14px; color: var(--text-muted);">Automatic gate lockdown for blacklisted or unrecognized plates.</p>
                </div>
                <div class="info-card">
                    <h3 style="font-family: Montserrat; color: var(--cyan);">Data Integrity</h3>
                    <p style="font-size: 14px; color: var(--text-muted);">Persistent logging to encrypted CSV storage for post-event analysis.</p>
                </div>
            </div>

            <div class="panel" style="margin-top: 30px;">
                <h4 style="font-family: Montserrat; margin-bottom: 25px;">The Technology Stack</h4>
                <div class="spec-grid">
                    <div class="spec-item"><span>Vision Model</span><strong>YOLOv8-Nano</strong></div>
                    <div class="spec-item"><span>Engine</span><strong>OpenCV / PyTorch</strong></div>
                    <div class="spec-item"><span>Backend</span><strong>Flask WSGI</strong></div>
                    <div class="spec-item"><span>Database</span><strong>Flat-file CSV</strong></div>
                </div>
            </div>

            <div class="workflow-section panel">
                <h4 style="text-align: center; font-family: 'Montserrat'; margin-bottom: 30px;">Pipeline Flow</h4>
                <div class="flow-steps">
                    <div><div class="step-dot"></div>Capture</div>
                    <div class="arrow-line"></div>
                    <div><div class="step-dot"></div>YOLO Detect</div>
                    <div class="arrow-line"></div>
                    <div><div class="step-dot"></div>OCR Extract</div>
                    <div class="arrow-line"></div>
                    <div><div class="step-dot" style="background: var(--green);"></div>Gate Signal</div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ==========================================
    // 1. GLOBAL STATE
    // ==========================================
    let entryLogs = []; 
    let lastSeenPlate = "";
    let isManualOverride = false;

    // ==========================================
    // 2. NAVIGATION
    // ==========================================
    function showSection(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.menu a').forEach(a => a.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        if(id === 'history') loadPersistentLogs();
    }

    // ==========================================
    // 3. CORE LOGIC (SYNC & DATA)
    // ==========================================
    
    // Fetch History from Backend (Snapshots included)
    async function loadPersistentLogs() {
        try {
            const response = await fetch('/history');
            const data = await response.json();
            
            // Map the backend data to our internal UI model
            entryLogs = data.map(row => ({
                time: row.timestamp,
                plate: row.plate,
                type: row.type,
                snapshot: row.snapshot || "", 
                status: (row.type === 'Blacklist') ? 'BLOCK' : 'ALLOW'
            }));
            
            updateUI();
        } catch (e) {
            console.warn("History sync failed.");
        }
    }

    // Live HUD updates from the Camera feed status
    async function syncWithAstraCore() {
        try {
            const response = await fetch('/gate_status');
            const data = await response.json();
            
            const hudPlate = document.getElementById("hud-plate");
            const container = document.getElementById("mainVideoContainer");
            const curtain = document.getElementById("lockCurtain");
            const overrideBtn = document.getElementById("overrideBtn");

            // Valid Plate Detection
            if (data.plate && data.plate !== "----" && data.plate.trim().length > 3) {
                hudPlate.innerText = data.plate;
                
                if (data.status === "BLOCK") {
                    hudPlate.style.color = "var(--red)";
                    overrideBtn.style.display = "block";
                    if (!isManualOverride) {
                        container.classList.add('lockdown-active');
                        curtain.style.display = "flex";
                    }
                } else {
                    hudPlate.style.color = "var(--green)";
                    container.classList.remove('lockdown-active');
                    curtain.style.display = "none";
                    overrideBtn.style.display = "none";
                }

                // If a new plate is detected, refresh logs to show the new entry immediately
                if (data.plate !== lastSeenPlate) {
                    lastSeenPlate = data.plate;
                    loadPersistentLogs(); 
                }
            } 
            // Idle / Scanning State
            else {
                hudPlate.innerText = "SCANNING...";
                hudPlate.style.color = "var(--cyan)";
                container.classList.remove('lockdown-active');
                curtain.style.display = "none";
                overrideBtn.style.display = "none";
                isManualOverride = false;
            }
        } catch (e) { }
    }

    // ==========================================
    // 4. UI RENDERING
    // ==========================================
    function updateUI() {
        // Update Counter Metrics
        document.getElementById("m1").innerText = entryLogs.length;
        document.getElementById("m2").innerText = entryLogs.filter(e => e.status !== "BLOCK").length;
        document.getElementById("m3").innerText = entryLogs.filter(e => e.status === "BLOCK").length;

        // Update Mini Feed (Sidebar)
        const mini = document.getElementById("miniHistory");
        mini.innerHTML = entryLogs.slice(0, 5).map(log => `
            <div style="background: var(--glass-heavy); padding: 12px; border-radius: 12px; margin-bottom: 10px; border-left: 3px solid ${log.status === 'BLOCK' ? 'var(--red)' : 'var(--cyan)'}; display: flex; align-items: center; gap: 10px;">
                <img src="/snapshots/${log.snapshot}" style="width: 45px; height: 30px; border-radius: 4px; object-fit: cover;" onerror="this.src='https://via.placeholder.com/45x30?text=NA'">
                <div>
                    <div style="font-weight: 800; font-size: 13px; font-family: Montserrat;">${log.plate}</div>
                    <div style="font-size: 9px; color: var(--text-muted);">${log.time}</div>
                </div>
            </div>
        `).join('') || '<p style="text-align:center; opacity:0.5; font-size:12px; margin-top:20px;">Waiting for detection...</p>';

        // Update Full Table (History Section)
        const body = document.getElementById("historyBody");
        body.innerHTML = entryLogs.map(log => `
            <tr>
                <td>${log.time}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img src="/snapshots/${log.snapshot}" style="width: 70px; height: 40px; border-radius: 6px; object-fit: cover;" onerror="this.src='https://via.placeholder.com/70x40?text=No+Image'">
                        <span style="font-weight: 800; font-family: Montserrat; color: var(--cyan);">${log.plate}</span>
                    </div>
                </td>
                <td>${log.type}</td>
                <td><span class="pill ${log.status === 'BLOCK' ? 'pill-block' : 'pill-auth'}">${log.status}</span></td>
            </tr>
        `).join('') || '<tr><td colspan="4" style="text-align:center;">No logs recorded</td></tr>';
    }

    // ==========================================
    // 5. INITIALIZATION & UTILS
    // ==========================================
    function manualUnlock() {
        isManualOverride = true;
        document.getElementById("lockCurtain").style.display = "none";
        document.getElementById("mainVideoContainer").classList.remove('lockdown-active');
        document.getElementById("overrideBtn").innerText = "üîì GATE OPENED";
    }

    function updateClock() {
        document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('en-GB');
    }

    // Set Timers
    setInterval(updateClock, 1000);
    setInterval(syncWithAstraCore, 1000);  // Update HUD every second
    setInterval(loadPersistentLogs, 5000); // Sync history every 5 seconds

    // First load
    updateClock();
    loadPersistentLogs();
</script>
</body>
</html>