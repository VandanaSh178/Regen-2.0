<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CampusCar | ANPR Dashboard</title>

<style>
:root{
  --bg:#0b1220;
  --card:#111827;
  --border:#1f2933;
  --green:#16a34a;
  --red:#dc2626;
  --yellow:#facc15;
  --text:#e5e7eb;
  --muted:#9ca3af;
}

body{
  margin:0;
  font-family:Segoe UI, Arial;
  background:var(--bg);
  color:var(--text);
}

/* CARDS */
.card{
  background:var(--card);
  border:2px solid var(--border);
  border-radius:14px;
  padding:22px;
  margin:20px;
  transition:0.3s;
}

/* FLASHING ALERT */
.flash{
  animation:flashBorder 1s infinite;
  border-color:var(--red);
}
@keyframes flashBorder{
  0%{box-shadow:0 0 0 var(--red)}
  50%{box-shadow:0 0 18px var(--red)}
  100%{box-shadow:0 0 0 var(--red)}
}

/* BADGES */
.badge{
  display:inline-block;
  padding:6px 14px;
  border-radius:6px;
  font-size:14px;
}
.green{background:var(--green)}
.red{background:var(--red)}

/* ANALYTICS */
.stats{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:15px;
}
.stat{
  background:#0b1325;
  border:1px solid var(--border);
  border-radius:10px;
  padding:14px;
  text-align:center;
}
.stat h1{
  margin:0;
  font-size:28px;
}
.stat p{
  margin:6px 0 0;
  color:var(--muted);
  font-size:13px;
}

/* TABLE */
table{width:100%;border-collapse:collapse}
td,th{padding:10px;border-bottom:1px solid var(--border)}
.thumb{
  width:90px;
  border-radius:6px;
  border:1px solid var(--border);
}
</style>
</head>

<body>

<!-- ðŸ”Š ALERT SOUND -->
<audio id="alarm">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<!-- LIVE DETECTION -->
<div class="card" id="liveCard">
  <h2>ðŸš¨ Live Detection</h2>
  <h1 id="plate">WAITING</h1>
  <div id="alert" class="badge green">NO ALERT</div>
  <p id="time">--</p>
  <p id="confidence">Confidence: --%</p>
  <p id="api">API: --</p>
</div>

<!-- ANALYTICS -->
<div class="card">
  <h2>ðŸ“Š Analytics</h2>
  <div class="stats">
    <div class="stat">
      <h1 id="statTotal">0</h1>
      <p>Total Detections</p>
    </div>
    <div class="stat">
      <h1 id="statUnique">0</h1>
      <p>Unique Vehicles</p>
    </div>
    <div class="stat">
      <h1 id="statBlacklist">0</h1>
      <p>Blacklist Hits</p>
    </div>
    <div class="stat">
      <h1 id="statAPI">OK</h1>
      <p>API Status</p>
    </div>
  </div>
</div>

<!-- LIVE CAMERA -->
<div class="card">
  <h2>ðŸ“· Live Camera Feed</h2>
  <img src="/video_feed" width="100%">
</div>

<!-- HISTORY -->
<div class="card">
  <h2>ðŸ“œ Detection History</h2>
  <table>
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Snapshot</th>
        <th>Plate</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="history"></tbody>
  </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  let lastPlate = "";

  /* ðŸ” LIVE DETECTION */
  async function refreshLatest(){
    try{
      const d = await fetch("/latest").then(r=>r.json());
      if(!d.plate) return;

      plate.innerText = d.plate;
      time.innerText = d.timestamp;
      confidence.innerText = "Confidence: " + d.confidence + "%";
      api.innerText = "API: " + (d.api_status || "OK");

      const alertBox = document.getElementById("alert");
      const liveCard = document.getElementById("liveCard");

      if(d.blacklist === "YES"){
        alertBox.innerText = "ðŸš« BLACKLIST ALERT";
        alertBox.className = "badge red";
        liveCard.classList.add("flash");

        if(d.plate !== lastPlate){
          document.getElementById("alarm").play();
        }
      }else{
        alertBox.innerText = "ALLOWED";
        alertBox.className = "badge green";
        liveCard.classList.remove("flash");
      }

      lastPlate = d.plate;
    }catch(e){}
  }

  /* ðŸ“œ HISTORY */
  async function loadHistory(){
    try{
      const rows = await fetch("/history").then(r=>r.json());
      const tbody = document.getElementById("history");
      tbody.innerHTML = "";

      if(rows.length === 0){
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align:center;color:#9ca3af">
              No detections yet
            </td>
          </tr>`;
        return;
      }

      rows.slice(-6).reverse().forEach(r=>{
        tbody.innerHTML += `
          <tr>
            <td>${r.timestamp}</td>
            <td>
              ${r.snapshot
                ? `<img class="thumb" src="/snapshots/${r.snapshot}">`
                : "N/A"}
            </td>
            <td>${r.plate}</td>
            <td>${r.blacklist} (${r.confidence}%)</td>
          </tr>`;
      });
    }catch(e){}
  }

  /* ðŸ“Š ANALYTICS */
  async function loadStats(){
    try{
      const s = await fetch("/stats").then(r=>r.json());

      statTotal.innerText = s.total;
      statUnique.innerText = s.unique;
      statBlacklist.innerText = s.blacklist;

      statAPI.innerText = s.api;
      statAPI.style.color =
        s.api === "OK" ? "#16a34a" :
        s.api === "LIMITED" ? "#facc15" :
        "#dc2626";
    }catch(e){}
  }

  /* INIT */
  loadHistory();
  loadStats();
  setInterval(refreshLatest, 1000);
  setInterval(loadHistory, 3000);
  setInterval(loadStats, 3000);

});
</script>

</body>
</html>
