<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIT Manipur Security Portal ‚Äì Admin Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Inter:wght@300;400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #0b0f1a;
            --panel: #151a2d;
            --border: rgba(255,255,255,0.08);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --green: #22c55e;
            --red: #ef4444;
            --blue: #3b82f6;
            --accent: #60a5fa;
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR RE-DESIGN --- */
        .sidebar { width: var(--sidebar-width); background: #0a0f22; border-right: 1px solid var(--border); padding: 30px 20px; display: flex; flex-direction: column; }
        .brand { font-family: 'Montserrat'; font-size: 18px; font-weight: 700; margin-bottom: 40px; color: var(--accent); letter-spacing: -0.5px; }
        .brand span { display: block; font-size: 10px; color: var(--muted); text-transform: uppercase; margin-top: 4px; letter-spacing: 1px; }
        
        .menu-label { font-size: 11px; color: var(--muted); font-weight: 700; text-transform: uppercase; margin: 20px 0 10px 10px; letter-spacing: 1px; }
        .menu a { display: flex; align-items: center; gap: 12px; padding: 14px 18px; margin-bottom: 5px; border-radius: 12px; color: var(--muted); text-decoration: none; cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 14px; }
        .menu a:hover, .menu a.active { background: rgba(96, 165, 250, 0.1); color: var(--accent); }
        .menu a.active { border-left: 4px solid var(--accent); font-weight: 600; }

        /* --- MAIN CONTENT --- */
        .main { flex: 1; padding: 40px; overflow-y: auto; background: radial-gradient(circle at top right, #111827, #0b0f1a); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .header h2 { margin: 0; font-family: 'Montserrat'; font-weight: 700; font-size: 24px; }

        /* --- DASHBOARD ELEMENTS --- */
        .section { display: none; }
        .section.active { display: block; animation: slideUp 0.4s ease forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 20px; padding: 25px; margin-bottom: 25px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--panel); border: 1px solid var(--border); padding: 20px; border-radius: 16px; }
        .stat-card h4 { margin: 0; font-size: 12px; color: var(--muted); text-transform: uppercase; }
        .stat-card .val { font-family: 'Share Tech Mono'; font-size: 32px; color: var(--accent); margin-top: 8px; }

        /* --- TABLE STYLING --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; margin-top: 10px; }
        th { text-align: left; color: var(--muted); font-size: 11px; text-transform: uppercase; padding: 10px 15px; }
        td { background: rgba(255,255,255,0.02); padding: 15px; font-size: 14px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        td:first-child { border-left: 1px solid var(--border); border-radius: 12px 0 0 12px; }
        td:last-child { border-right: 1px solid var(--border); border-radius: 0 12px 12px 0; }
        
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; font-family: 'Share Tech Mono'; }
        .badge-success { background: rgba(34, 197, 94, 0.1); color: var(--green); border: 1px solid var(--green); }
        .badge-danger { background: rgba(239, 68, 68, 0.1); color: var(--red); border: 1px solid var(--red); }
        
        /* --- UTILITIES --- */
        .btn-add { background: var(--blue); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-add:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4); }
        .search-bar { background: #0b0f1a; border: 1px solid var(--border); padding: 12px 20px; border-radius: 12px; color: white; width: 350px; outline: none; }
        .search-bar:focus { border-color: var(--accent); }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-box { background: var(--panel); padding: 40px; border-radius: 24px; width: 450px; border: 1px solid var(--border); }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="brand">üõ°Ô∏è NIT MANIPUR <span>Security Admin Hub</span></div>
        
        <div class="menu-label">Main Monitor</div>
        <div class="menu">
            <a class="active" onclick="showSection('dashboard', this)">üìä Operational Hub</a>
            <a onclick="showSection('logs', this)">üìÑ Detection History</a>
        </div>

        <div class="menu-label">Administration</div>
        <div class="menu">
            <a onclick="showSection('vehicles', this)">üöó Registry Ops</a>
            <a onclick="window.location.href='/admin/export_excel'" style="color: var(--green);">üìÇ Export Audit Log</a>
        </div>

        <div class="menu" style="margin-top: auto;">
            <a href="/admin/logout" style="color: var(--red); border: 1px solid rgba(239, 68, 68, 0.2);">‚ö†Ô∏è System Logout</a>
        </div>
    </div>

    <div class="main">
        <div class="header">
            <h2 id="page-title">Operational Hub</h2>
            <div style="display: flex; align-items: center; gap: 15px; font-family: 'Share Tech Mono'; font-size: 14px; color: var(--muted);">
                <span id="liveClock">00:00:00</span>
                <div style="display: flex; align-items: center; gap: 8px; background: rgba(34, 197, 94, 0.1); color: var(--green); padding: 6px 15px; border-radius: 30px;">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--green); box-shadow: 0 0 10px var(--green);"></div>
                    CORE ACTIVE
                </div>
            </div>
        </div>

        <div id="dashboard" class="section active">
            <div class="stat-grid">
                <div class="stat-card"><h4>Total Detections</h4><div class="val" id="stat-total">--</div></div>
                <div class="stat-card"><h4>Verified Staff</h4><div class="val" id="stat-faculty" style="color: var(--green)">--</div></div>
                <div class="stat-card"><h4>Security Flags</h4><div class="val" id="stat-blacklist" style="color: var(--red)">--</div></div>
            </div>

            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-family: 'Montserrat'; font-size: 16px;">Gate 01 - Main Entrance (YOLOv8 Stream)</h3>
                    <span class="badge badge-danger">LIVE</span>
                </div>
                <div style="border-radius: 12px; overflow: hidden; background: #000; border: 1px solid var(--border);">
                    <img src="/video_feed" style="width: 100%; max-height: 480px; object-fit: contain;">
                </div>
            </div>
        </div>

        <div id="logs" class="section">
            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3>Audit Trail</h3>
                    <button class="btn-add" style="background: transparent; border: 1px solid var(--border); color: var(--text);" onclick="refreshLogs()">Sync Records</button>
                </div>
                <table>
                    <thead><tr><th>Time</th><th>Visual</th><th>ID Plate</th><th>Entity</th><th>Action</th></tr></thead>
                    <tbody id="logTable"></tbody>
                </table>
            </div>
        </div>

        <div id="vehicles" class="section">
            <div class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px;">
                    <h3>Authorized Database</h3>
                    <div style="display:flex; gap: 12px;">
                        <input type="text" id="dbSearch" class="search-bar" placeholder="Filter by plate or name..." onkeyup="filterVehicles()">
                        <button class="btn-add" onclick="openModal('vehicleModal')">+ Register Vehicle</button>
                    </div>
                </div>
                <table>
                    <thead><tr><th>Plate ID</th><th>Owner</th><th>Designation</th><th>Action</th></tr></thead>
                    <tbody id="vehicleTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="vehicleModal" class="modal">
        <div class="modal-box">
            <h3 style="margin-top: 0; font-family: 'Montserrat';">Register New Entry</h3>
            <p style="color: var(--muted); font-size: 13px; margin-bottom: 25px;">This will add the vehicle to the whitelist database.</p>
            
            <label style="display: block; font-size: 11px; color: var(--muted); margin-bottom: 5px;">PLATE NUMBER</label>
            <input id="vPlate" class="search-bar" style="width: 100%; margin-bottom: 20px;" placeholder="MN01X1234">
            
            <label style="display: block; font-size: 11px; color: var(--muted); margin-bottom: 5px;">OWNER NAME</label>
            <input id="vOwner" class="search-bar" style="width: 100%; margin-bottom: 20px;" placeholder="John Doe">
            
            <label style="display: block; font-size: 11px; color: var(--muted); margin-bottom: 5px;">ROLE</label>
            <select id="vType" class="search-bar" style="width: 100%; margin-bottom: 30px; appearance: auto;">
                <option value="Student">Student</option>
                <option value="Faculty">Faculty</option>
                <option value="Official">Official</option>
                <option value="Blacklist">Blacklist</option>
            </select>
            
            <button class="btn-add" style="width:100%; justify-content: center;" onclick="saveVehicle()">Commit to Database</button>
            <button onclick="closeModal()" style="width:100%; margin-top:15px; background:transparent; color:var(--muted); border:none; cursor:pointer; font-size: 13px;">Cancel</button>
        </div>
    </div>

    <script>
        // --- CORE UI LOGIC ---
        function showSection(id, el) {
            document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
            document.querySelectorAll(".menu a").forEach(a => a.classList.remove("active"));
            
            document.getElementById(id).classList.add("active");
            el.classList.add("active");
            document.getElementById('page-title').innerText = el.innerText;
            
            if(id === 'logs') refreshLogs();
            if(id === 'vehicles') loadRegisteredVehicles();
        }

        setInterval(() => {
            document.getElementById('liveClock').innerText = new Date().toLocaleTimeString();
        }, 1000);

        function openModal(id) { document.getElementById(id).style.display = "flex"; }
        function closeModal() { document.querySelectorAll(".modal").forEach(m => m.style.display = "none"); }

        // --- DATA INTERACTION ---
        async function refreshLogs() {
            try {
                const res = await fetch('/history');
                const data = await res.json();
                document.getElementById("logTable").innerHTML = data.reverse().map(log => `
                    <tr>
                        <td style="font-family: 'Share Tech Mono'; color: var(--muted);">${log.timestamp}</td>
                        <td><img src="/snapshots/${log.snapshot}" class="thumb" style="width: 80px; border-radius: 4px;"></td>
                        <td style="font-weight:bold; font-family: 'Share Tech Mono'; color: var(--accent); font-size: 16px;">${log.plate}</td>
                        <td>${log.type}</td>
                        <td><span class="badge ${log.type === 'Blacklist' ? 'badge-danger' : 'badge-success'}">
                            ${log.type === 'Blacklist' ? 'DENIED' : 'AUTHORIZED'}</span></td>
                    </tr>
                `).join('');
            } catch (e) { console.error("History sync failed"); }
        }

        async function loadRegisteredVehicles() {
            const res = await fetch('/admin/get_vehicles');
            const data = await res.json();
            document.getElementById("vehicleTable").innerHTML = data.map(v => `
                <tr>
                    <td style="font-family: 'Share Tech Mono'; font-weight: bold; color: var(--accent);">${v.plate}</td>
                    <td>${v.owner}</td>
                    <td><span class="badge badge-success" style="background: rgba(96, 165, 250, 0.1); color: var(--accent); border-color: var(--accent);">${v.type}</span></td>
                    <td><button onclick="deleteVehicle('${v.plate}')" style="color:var(--red); background:none; border:1px solid rgba(239, 68, 68, 0.2); padding: 5px 12px; border-radius: 6px; cursor:pointer;">Remove</button></td>
                </tr>
            `).join('');
        }

        async function saveVehicle() {
            const payload = {
                plate: document.getElementById("vPlate").value.toUpperCase(),
                owner: document.getElementById("vOwner").value,
                type: document.getElementById("vType").value
            };
            const res = await fetch('/admin/add_vehicle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if(res.ok) { closeModal(); loadRegisteredVehicles(); }
        }

        async function updateStats() {
            const stats = await fetch('/stats').then(r => r.json());
            document.getElementById('stat-total').innerText = stats.total;
            document.getElementById('stat-faculty').innerText = stats.faculty + stats.students;
            document.getElementById('stat-blacklist').innerText = stats.blacklist;
        }

        updateStats();
        setInterval(updateStats, 5000);
    </script>
</body>
</html>