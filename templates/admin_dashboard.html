<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIT Manipur Security Portal ‚Äì Admin Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Inter:wght@300;400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0b0f1a;
            --panel: #151a2d;
            --border: rgba(255,255,255,0.08);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --green: #22c55e;
            --red: #ef4444;
            --blue: #3b82f6;
            --accent: #60a5fa;
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: var(--sidebar-width); background: #0a0f22; border-right: 1px solid var(--border); padding: 30px 20px; display: flex; flex-direction: column; }
        .brand { font-family: 'Montserrat'; font-size: 18px; font-weight: 700; margin-bottom: 40px; color: var(--accent); letter-spacing: -0.5px; }
        .brand span { display: block; font-size: 10px; color: var(--muted); text-transform: uppercase; margin-top: 4px; letter-spacing: 1px; }
        
        .menu-label { font-size: 11px; color: var(--muted); font-weight: 700; text-transform: uppercase; margin: 20px 0 10px 10px; letter-spacing: 1px; }
        .menu a { display: flex; align-items: center; gap: 12px; padding: 14px 18px; margin-bottom: 5px; border-radius: 12px; color: var(--muted); text-decoration: none; cursor: pointer; transition: 0.3s; font-size: 14px; }
        .menu a:hover, .menu a.active { background: rgba(96, 165, 250, 0.1); color: var(--accent); }
        .menu a.active { border-left: 4px solid var(--accent); font-weight: 600; }

        /* --- MAIN CONTENT --- */
        .main { flex: 1; padding: 40px; overflow-y: auto; background: radial-gradient(circle at top right, #111827, #0b0f1a); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .header h2 { margin: 0; font-family: 'Montserrat'; font-weight: 700; font-size: 24px; }

        /* --- DASHBOARD ELEMENTS --- */
        .section { display: none; }
        .section.active { display: block; animation: slideUp 0.4s ease forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 20px; padding: 25px; margin-bottom: 25px; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--panel); border: 1px solid var(--border); padding: 20px; border-radius: 16px; }
        .stat-card h4 { margin: 0; font-size: 11px; color: var(--muted); text-transform: uppercase; }
        .stat-card .val { font-family: 'Share Tech Mono'; font-size: 32px; color: var(--accent); margin-top: 8px; }

        /* --- TABLE STYLING --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { text-align: left; color: var(--muted); font-size: 11px; text-transform: uppercase; padding: 0 15px; }
        td { background: rgba(255,255,255,0.03); padding: 12px 15px; font-size: 14px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        td:first-child { border-left: 1px solid var(--border); border-radius: 10px 0 0 10px; }
        td:last-child { border-right: 1px solid var(--border); border-radius: 0 10px 10px 0; }
        
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; font-family: 'Share Tech Mono'; display: inline-block; }
        .badge-success { background: rgba(34, 197, 94, 0.1); color: var(--green); border: 1px solid var(--green); }
        .badge-danger { background: rgba(239, 68, 68, 0.1); color: var(--red); border: 1px solid var(--red); }
        
        .btn-add { background: var(--blue); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-add:hover { transform: translateY(-2px); opacity: 0.9; }
        .search-bar { background: #0b0f1a; border: 1px solid var(--border); padding: 12px; border-radius: 10px; color: white; width: 300px; outline: none; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-box { background: var(--panel); padding: 35px; border-radius: 20px; width: 400px; border: 1px solid var(--border); }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="brand">üõ°Ô∏è NIT MANIPUR <span>Security Admin Hub</span></div>
        <div class="menu-label">Main Monitor</div>
        <div class="menu">
            <a class="active" onclick="showSection('dashboard', this)">üìä Operational Hub</a>
            <a onclick="showSection('logs', this)">üìÑ Detection History</a>
        </div>
        <div class="menu-label">Administration</div>
        <div class="menu">
            <a onclick="showSection('vehicles', this)">üöó Registry Ops</a>
            <a onclick="window.location.href='/admin/export_excel'" style="color: var(--green);">üìÇ Export Audit Log</a>
        </div>
        <div class="menu" style="margin-top: auto;">
            <a href="/admin/logout" style="color: var(--red); border: 1px solid rgba(239, 68, 68, 0.2);">‚ö†Ô∏è System Logout</a>
        </div>
    </div>

    <div class="main">
        <div class="header">
            <h2 id="page-title">Operational Hub</h2>
            <div style="display: flex; align-items: center; gap: 15px; font-family: 'Share Tech Mono';">
                <span id="liveClock" style="color: var(--muted);">00:00:00</span>
                <div style="background: rgba(34, 197, 94, 0.1); color: var(--green); padding: 5px 12px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                    <span style="width: 8px; height: 8px; background: var(--green); border-radius: 50%; box-shadow: 0 0 8px var(--green);"></span>
                    LIVE
                </div>
            </div>
        </div>

        <div id="dashboard" class="section active">
            <div class="stat-grid">
                <div class="stat-card"><h4>Total Detections</h4><div class="val" id="stat-total">0</div></div>
                <div class="stat-card"><h4>Verified Access</h4><div class="val" id="stat-faculty" style="color: var(--green)">0</div></div>
                <div class="stat-card"><h4>Security Flags</h4><div class="val" id="stat-blacklist" style="color: var(--red)">0</div></div>
            </div>
            <div class="panel">
                <h3 style="margin: 0 0 20px 0; font-size: 14px; color: var(--muted); text-transform: uppercase;">Real-time Gate Feed</h3>
                <div style="border-radius: 12px; overflow: hidden; background: #000; border: 1px solid var(--border); aspect-ratio: 16/9;">
                    <img src="/video_feed" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.parentElement.innerHTML='<p style=\"text-align:center;padding-top:20%\">Stream Offline</p>'">
                </div>
            </div>
        </div>

        <div id="logs" class="section">
            <div class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>Audit Trail</h3>
                    <button class="btn-add" style="background:transparent; border:1px solid var(--border);" onclick="refreshLogs()">üîÑ Sync Now</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Evidence</th>
                            <th>Plate ID</th>
                            <th>Category</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="logTable"></tbody>
                </table>
            </div>
        </div>

        <div id="vehicles" class="section">
            <div class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                    <h3>Authorized Database</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="dbSearch" class="search-bar" placeholder="Filter..." onkeyup="filterVehicles()">
                        <button class="btn-add" onclick="openModal('vehicleModal')">+ Register</button>
                    </div>
                </div>
                <table>
                    <thead><tr><th>Plate ID</th><th>Owner</th><th>Role</th><th>Action</th></tr></thead>
                    <tbody id="vehicleTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="vehicleModal" class="modal">
        <div class="modal-box">
            <h3 style="margin: 0 0 10px 0;">New Registration</h3>
            <input id="vPlate" class="search-bar" style="width:100%; margin-bottom:15px;" placeholder="Plate (e.g. MN01...)">
            <input id="vOwner" class="search-bar" style="width:100%; margin-bottom:15px;" placeholder="Owner Name">
            <select id="vType" class="search-bar" style="width:100%; margin-bottom:20px; background:#0b0f1a; color:white;">
                <option value="Faculty">Faculty</option>
                <option value="Student">Student</option>
                <option value="Official">Official</option>
                <option value="Blacklist">Blacklist</option>
            </select>
            <button class="btn-add" style="width:100%; justify-content:center;" onclick="saveVehicle()">Commit to DB</button>
            <button onclick="closeModal()" style="width:100%; margin-top:10px; background:none; border:none; color:var(--muted); cursor:pointer;">Cancel</button>
        </div>
    </div>

    <script>
        // --- NAVIGATION ---
        function showSection(id, el) {
            document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
            document.querySelectorAll(".menu a").forEach(a => a.classList.remove("active"));
            document.getElementById(id).classList.add("active");
            el.classList.add("active");
            document.getElementById('page-title').innerText = el.innerText.trim();
            
            if(id === 'logs') refreshLogs();
            if(id === 'vehicles') loadRegisteredVehicles();
        }

        // --- CORE FETCH LOGIC (HISTORY) ---
        async function refreshLogs() {
            try {
                // Fetching with a cache-busting timestamp 't'
                const res = await fetch(`/history?t=${new Date().getTime()}`, { cache: "no-store" });
                const data = await res.json();
                
                // Update Dashboard Stat Cards
                document.getElementById('stat-total').innerText = data.length;
                document.getElementById('stat-faculty').innerText = data.filter(d => d.type !== 'Blacklist' && d.type !== 'Unknown').length;
                document.getElementById('stat-blacklist').innerText = data.filter(d => d.type === 'Blacklist').length;

                // Render Log Table
                const tbody = document.getElementById("logTable");
                if (!data.length) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--muted);">Waiting for detections...</td></tr>';
                    return;
                }

                // Show only last 20 detections for performance, newest first
                tbody.innerHTML = data.slice(-20).reverse().map(log => `
                    <tr>
                        <td style="font-family:'Share Tech Mono'; color:var(--muted);">${log.timestamp}</td>
                        <td>
                            <div style="width:60px; height:35px; border-radius:4px; overflow:hidden; background:#000;">
                                <img src="/snapshots/${log.snapshot}" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='https://via.placeholder.com/60x35?text=NA'">
                            </div>
                        </td>
                        <td style="font-weight:bold; color:var(--accent); font-family:'Share Tech Mono';">${log.plate}</td>
                        <td style="font-size:12px;">${log.type}</td>
                        <td>
                            <span class="badge ${log.type === 'Blacklist' ? 'badge-danger' : 'badge-success'}">
                                ${log.type === 'Blacklist' ? 'üõë DENIED' : '‚úÖ ACCESS'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            } catch (e) { console.error("History sync failed."); }
        }

        // --- REGISTRY OPS ---
        async function loadRegisteredVehicles() {
            try {
                const res = await fetch('/admin/get_vehicles');
                const data = await res.json();
                document.getElementById("vehicleTable").innerHTML = data.map(v => `
                    <tr>
                        <td style="font-family:'Share Tech Mono'; font-weight:bold; color:var(--accent);">${v.plate}</td>
                        <td>${v.owner}</td>
                        <td><span class="badge" style="border:1px solid var(--border);">${v.type}</span></td>
                        <td><button onclick="deleteVehicle('${v.plate}')" style="color:var(--red); background:none; border:none; cursor:pointer;">Remove</button></td>
                    </tr>
                `).join('');
            } catch (e) { console.error("Registry fetch failed."); }
        }

        async function saveVehicle() {
            const payload = {
                plate: document.getElementById("vPlate").value.toUpperCase().trim(),
                owner: document.getElementById("vOwner").value.trim(),
                type: document.getElementById("vType").value
            };
            if(!payload.plate || !payload.owner) return alert("Fill all fields");

            const res = await fetch('/admin/add_vehicle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if(res.ok) { closeModal(); loadRegisteredVehicles(); }
        }

        async function deleteVehicle(plate) {
            if(!confirm(`Delete ${plate}?`)) return;
            await fetch(`/admin/delete_vehicle/${plate}`, { method: 'DELETE' });
            loadRegisteredVehicles();
        }

        // --- UI UTILS ---
        function filterVehicles() {
            const term = document.getElementById("dbSearch").value.toUpperCase();
            document.querySelectorAll("#vehicleTable tr").forEach(row => {
                row.style.display = row.innerText.toUpperCase().includes(term) ? "" : "none";
            });
        }
        function openModal(id) { document.getElementById(id).style.display = "flex"; }
        function closeModal() { document.querySelectorAll(".modal").forEach(m => m.style.display = "none"); }

        // --- REFRESH INTERVALS ---
        setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString(); }, 1000);
        
        // REFRESH LOGS EVERY 2 SECONDS FOR REAL-TIME FEEL
        setInterval(() => {
            const active = document.querySelector('.section.active').id;
            if(active === 'dashboard' || active === 'logs') refreshLogs();
        }, 2000);

        window.onload = refreshLogs;
    </script>
</body>
</html>